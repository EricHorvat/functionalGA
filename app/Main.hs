module Main where

import GA
import GABase
import Selection
import Cross
import Mutation
import Replace

import Character
import GAinGA
import MathGA
import Random

import Control.Monad.State.Lazy
import Data.CSV
import Data.String
import Data.Either
import System.Random
import Text.ParserCombinators.Parsec

import Data.Time

main :: IO ()
main = do
  start <- getCurrentTime
  mainMath
  stop <- getCurrentTime
  print $ diffUTCTime stop start

main2 :: IO()
main2 = do
  seed <- newStdGen
  print $ randInts seed 2

mainCharacter :: IO ()
mainCharacter = do
  let filenames = ["./res/armas.csv", "./res/botas.csv", "./res/cascos.csv", "./res/guantes.csv", "./res/pecheras.csv"]
  fileData <- mapM (parseFromFile csvFile) filenames
  stdGen <- newStdGen
  characterGA fileData stdGen

characterGA :: [ Either ParseError [[String]]] -> StdGen -> IO ()
characterGA fileData stdGen = if map lefts [fileData] == [[]]
  then
    generalMain 500 50 16 warriorFitness chromosomeGenerator
  else
    print (map lefts [fileData])
  where
    parsedData = map( map(map(read :: String->Double)).fromRight [["ERROR"]]) fileData
    chromosomeGenerator = characterChromosomeGenerator parsedData


generalMain :: Int -> Int -> Int -> FitnessFunction -> ChromosomeGenerator -> IO()
generalMain its popSize k fitnessF chromosomeGenerator = do
  stdGen <- newStdGen
  let seedPop = initialPopulation chromosomeGenerator stdGen popSize
  let (s1:s2:s3:s4:sEnd:_) = randSeeds (snd seedPop) 5
  let selectionMethod = multipleSelection [(eliteSelection, 0.25), (rankingSelection, 0.75)]
  let resultPop = ga its (const False) (nextGen selectionMethod k cross1point 0.2 mutateMultiGenChromosome 0.1 replaceOld selectionMethod fitnessF) seedPop
  print resultPop
  print $ head $ eliteSelection resultPop 1 fitnessF stdGen
  print $ fitnessF $ head $ eliteSelection resultPop 1 fitnessF stdGen


mainMath :: IO ()
mainMath = generalMain 500 50 16 sumFitness (boundedIntChromosomeGenerator 5 (-150,150))

mainMath2 :: IO()
mainMath2 = generalMain 500 50 16 (polynomialRootFitness 5) (boundedIntChromosomeGenerator 5 (-150,150))

mainGA :: IO ()
mainGA = generalMain 2 8 4 gaFitness gaChromosomeGenerator
--[[4,0,6,108,0,0.9657205138977931,1,0.16761356364391944,1,7,117630269 440532600,2437],[4,0,5,209,1,0.904298156446967,1,0.3800676259667377,1,7,436385556 1604726929,1482],[3,1,1,123,1,0.30153134117165226,0,0.22640459960600912,1,2,1740065608 983248377,1206],[4,1,6,12,2,0.8223988409369103,0,0.8509960077142842,1,3,1767106081 491603842,2219],[4,1,0,165,2,0.8266505713540491,1,0.5758027468964948,0,8,2109645030 1632418462,1836],[2,0,1,52,0,0.5356921128628559,0,0.15332898979885834,0,1,1255656369 1140773927,1935],[3,1,2,233,2,0.3291684873174192,0,0.880004294245528,1,0,702978734 1813323721,1866],[4,1,6,217,2,0.29058773236838875,0,0.3494065424528807,0,1,752534522 1321679186,1936],[3,0,4,245,1,0.5852908501057351,0,0.7722395770714778,1,7,1373250019 1994228980,2192],[2,0,0,227,3,0.5156473352512113,0,6.996091631349566e-2,1,1,1316019119 1010939910,869],[4,0,1,145,1,0.6282414324343552,1,0.42057250139482805,0,2,63913070 700200634,2115],[2,1,5,205,2,0.15733696441949718,1,0.6166545195951797,1,8,1402462219 1864394963,744],[3,1,5,21,2,0.35337988197444203,0,0.867714138782279,1,8,1723129741 881105893,1678],[4,1,4,241,3,3.3614314260378864e-2,0,0.876386097382613,0,4,1037611299 1242916411,1686],[2,1,8,130,2,0.7020461925103004,0,0.2916116492510259,1,2,2056951042 751271876,1575],[4,1,8,106,3,0.4425998702010825,1,0.22899705886790833,0,2,149188131 1423821670,1249],[4,0,6,108,0,0.9657205138977931,1,0.16761356364391944,1,7,117630269 440532600,2437],[4,0,5,209,1,0.904298156446967,1,0.3800676259667377,1,7,436385556 1604726929,1482],[3,1,1,192,1,0.30153134117165226,0,0.22640459960600912,1,2,1740065608 983248377,1206],[2,1,6,12,2,0.8223988409369103,0,0.8509960077142842,1,3,1767106081 491603842,2219],[4,0,0,152,0,0.7238111283822417,0,0.37765681784031757,0,7,1380339577 959868668,1111],[2,1,0,237,2,0.12098422896129035,0,0.7975724786962339,1,8,705988265 2124062997,2248],[3,0,2,149,0,0.6233319437850703,0,0.8419219541528208,1,8,216067382 830034651,739],[4,0,3,74,0,0.13531802010219107,0,0.3413688613213134,1,1,1545715155 1502584445,2057],[3,0,4,102,3,0.8231130948483419,1,0.9092655565358968,0,1,565795259 1191845169,1657],[2,0,2,115,3,0.652634452488793,1,0.7344072593075054,0,4,883898562 208556099,1730],[3,1,8,19,0,0.46579967498013486,1,0.17409487478399022,1,1,859834945 1372750428,1218],[3,1,7,166,0,0.9108202371632526,0,0.42413192192511595,0,0,1698034549 389461358,857],[2,0,3,66,3,0.1608165147281635,1,0.37967255213830875,1,2,1207956333 1553655687,1145],[2,1,0,213,3,0.2873391716483126,1,0.9653205917124504,0,3,332446956 1734560946,2249],[2,1,2,71,2,0.6077804204046019,1,0.705874507821802,0,1,39531257 259627341,2084],[3,0,0,238,1,2.829624205407344e-2,0,0.8764453217652152,0,1,410704506 1915466205,1869],[2,0,8,176,0,0.6131299145682627,1,0.9161818472112575,0,4,374749482 932177135,1642],[3,1,0,119,2,0.9734264269743503,0,0.4138192983550103,1,7,1922818922 1113082394,1939],[4,1,0,226,3,0.11675221876978525,1,0.21844467631627296,0,1,406404439 621437859,1937],[2,1,2,77,2,0.1505448991528422,1,0.9087082947188482,1,7,1635853745 129793324,2334],[2,0,4,70,2,0.6108259107550797,1,0.2173503838800276,1,8,787637006 802343118,841],[3,1,1,133,3,0.43903364694619795,0,0.8805493408538441,0,3,389953568 310698583,2269],[3,1,1,174,1,0.9539939686882908,1,0.5634114685864607,0,7,1391072194 1966537447,2125],[2,0,2,222,3,0.31916949708144393,0,0.585799591364523,0,2,771171236 649129392,1026],[4,0,5,140,3,0.8133298122663919,1,7.978520689023005e-2,1,1,702346307 27650840,2227],[4,0,3,129,1,9.277543840577696e-2,1,0.3918694923462428,1,1,217986034 338390116,2135],[4,0,3,228,3,0.5236917445466649,1,0.8849137828948128,0,6,1760908292 1683489704,1920],[3,0,1,64,2,0.6172334568197525,0,8.427896835171877e-2,0,1,2074294738 1474892912,1136],[4,1,4,46,3,8.473775727420962e-2,0,0.780363856588553,1,4,368875129 519295375,505],[2,1,7,182,1,0.16483511846174714,0,0.6210768953301663,1,6,759577690 1062011152,1076],[4,0,6,108,0,0.9657205138977931,1,0.16761356364391944,0,5,117630269 440532600,2437],[4,0,5,209,1,0.904298156446967,1,0.3800676259667377,0,7,1378645524 2132614126,1482],[4,1,6,12,2,0.8223988409369103,0,0.8509960077142842,1,3,1767106081 491603842,2219],[2,1,1,123,1,0.30153134117165226,0,0.22640459960600912,1,2,1740065608 983248377,1206]]
--1.0
--585.405771175s (50, 4) -- selectionMethod = eliteSelection

--[[4,0,4,94,2,0.9769746354621281,1,0.4218447052187252,0,4,1160208261 1293987653,1523],[4,0,4,94,2,0.9769746354621281,1,0.4218447052187252,0,4,1160208261 1293987653,1523],[2,1,8,178,1,0.2105837856129973,1,0.6986507372331984,1,4,2113968342 983248377,2109],[2,1,8,178,1,0.2105837856129973,1,0.6986507372331984,1,4,2113968342 983248377,2109],[2,1,8,178,1,0.2105837856129973,1,0.6986507372331984,1,1,1712282667 2129280868,2109],[4,0,4,234,2,0.9769746354621281,1,0.4218447052187252,0,4,1160208261 1293987653,1523],[4,0,4,94,2,0.9769746354621281,1,0.4218447052187252,0,4,1160208261 1293987653,1523],[2,1,8,178,1,0.2105837856129973,1,0.6986507372331984,1,4,2113968342 983248377,2109]]
--[4,0,4,94,2,0.9769746354621281,1,0.4218447052187252,0,4,1160208261 1293987653,1523]
--1.0
--19.055543049s